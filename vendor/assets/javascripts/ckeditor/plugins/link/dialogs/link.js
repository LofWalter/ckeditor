/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
(function(){CKEDITOR.dialog.add("link",function(f){var h=CKEDITOR.plugins.link,g=f.lang.common,e=f.lang.link;return{title:e.title,minWidth:350,minHeight:230,resizable:CKEDITOR.DIALOG_RESIZE_NONE,buttons:[CKEDITOR.dialog.okButton],contents:[{id:"info",label:e.info,title:e.info,elements:[{id:"linkType",type:"select",label:e.type,"default":"url",items:[[e.toUrl,"url"],[e.toEmail,"email"]],onChange:function(){var a=this.getDialog(),b=["urlOptions","anchorOptions","emailOptions"],d=this.getValue(),c=a.definition.getContents("upload"),
c=c&&c.hidden;"url"==d?(f.config.linkShowTargetTab&&a.showPage("target"),c||a.showPage("upload")):(a.hidePage("target"),c||a.hidePage("upload"));for(c=0;c<b.length;c++){var e=a.getContentElement("info",b[c]);e&&(e=e.getElement().getParent().getParent(),b[c]==d+"Options"?e.show():e.hide())}a.layout()},setup:function(a){this.setValue(a.type||"url")},commit:function(a){a.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",
label:g.protocol,"default":"http://",items:[["http://‎","http://"],["https://‎","https://"],["ftp://‎","ftp://"],[e.other,""]],setup:function(a){a.url&&this.setValue(a.url.protocol||"")},commit:function(a){a.url||(a.url={});a.url.protocol=this.getValue()}},{type:"text",id:"url",label:g.url,onLoad:function(){this.allowOnChange=!0},onKeyUp:function(){this.allowOnChange=!1;var a=this.getDialog().getContentElement("info","protocol"),b=this.getValue(),d=/^((javascript:)|[#\/\.\?])/i,c=/^(http|https|ftp):\/\/(?=.)/i.exec(b);
c?(this.setValue(b.substr(c[0].length)),a.setValue(c[0].toLowerCase())):d.test(b)&&a.setValue("");this.allowOnChange=!0},onChange:function(){if(this.allowOnChange)this.onKeyUp()},validate:function(){var a=this.getDialog();if(a.getContentElement("info","linkType")&&"url"!=a.getValueOf("info","linkType"))return!0;if(!f.config.linkJavaScriptLinksAllowed&&/javascript\:/.test(this.getValue()))return alert(g.invalidValue),!1;if(this.getDialog().fakeObj)return!0},setup:function(a){this.allowOnChange=!1;
a.url&&this.setValue(a.url.url);this.allowOnChange=!0},commit:function(a){this.onChange();a.url||(a.url={});a.url.url=this.getValue();this.allowOnChange=!1}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().show()}},{type:"hbox",widths:["50%","50%"],children:[{type:"checkbox",id:"linkTargetType",label:"Open in new window",setup:function(a){a.target&&this.setValue("notSet"===a.target.type?!1:!0)},commit:function(a){a.target||(a.target={});var b=this.getValue()?
"_blank":"notSet";a.target.type=b;a.target.name=b}},{type:"button",id:"upload",label:"Upload document",style:"float: right",onClick:function(){var a=this.getDialog();f.config.uploadCallback(function(b){a.getContentElement("info","url").setValue(b||"")})}}]}]},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:e.emailAddress,validate:function(){var a=this.getDialog();if(!a.getContentElement("info","linkType")||"email"!=a.getValueOf("info","linkType"))return!0;if(!/.+@.+/.test(this.getValue()))return alert("Invalid email address"),
!1},setup:function(a){a.email&&this.setValue(a.email.address);(a=this.getDialog().getContentElement("info","linkType"))&&"email"==a.getValue()&&this.select()},commit:function(a){a.email||(a.email={});a.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:e.emailSubject,setup:function(a){a.email&&this.setValue(a.email.subject)},commit:function(a){a.email||(a.email={});a.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:e.emailBody,rows:3,"default":"",setup:function(a){a.email&&
this.setValue(a.email.body)},commit:function(a){a.email||(a.email={});a.email.body=this.getValue()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}}]}],onShow:function(){var a=this.getParentEditor(),b=a.getSelection(),d=null;(d=h.getSelectedLink(a))&&d.hasAttribute("href")?b.getSelectedElement()||b.selectElement(d):d=null;a=h.parseLinkAttributes(a,d);this._.selectedElement=d;this.setupContent(a)},onOk:function(){var a={};this.commitContent(a);var b=
f.getSelection(),d=h.getLinkAttributes(f,a);if("email"===a.type&&!a.email.address||"url"===a.type&&!a.url.url)f.execCommand("unlink");else if(this._.selectedElement){var c=this._.selectedElement,e=c.data("cke-saved-href"),g=c.getHtml();c.setAttributes(d.set);c.removeAttributes(d.removed);if(e==g||"email"==a.type&&-1!=g.indexOf("@"))c.setHtml("email"==a.type?a.email.address:d.set["data-cke-saved-href"]),b.selectElement(c);delete this._.selectedElement}else b=b.getRanges()[0],b.collapsed&&(a=new CKEDITOR.dom.text("email"==
a.type?a.email.address:d.set["data-cke-saved-href"],f.document),b.insertNode(a),b.selectNodeContents(a)),d=new CKEDITOR.style({element:"a",attributes:d.set}),d.type=CKEDITOR.STYLE_INLINE,d.applyToRange(b,f),b.select()},onFocus:function(){var a=this.getContentElement("info","linkType");a&&"url"==a.getValue()&&(a=this.getContentElement("info","url"),a.select())}}})})();